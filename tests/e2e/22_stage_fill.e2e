# Test: agents spread to fill all sides of the stage area
# Spawns a crowd from multiple directions with high speed,
# verifies agents distribute across the entire StageFloor ring
# (not just clustering on one side).
#
# Stage building: (30-33, 25-28), center (32, 27)
# StageFloor ring: radius 8 around center (~185 tiles)
# Paths are kept narrow and stop before the ring to preserve tiles.

reset_game
set_spawn_enabled 0
set_agent_speed 10
wait_frames 5

# Force a very long artist so agents keep watching through the test.
# At 10x clock speed, 1 real second = 20 game minutes, so 9999 minutes
# lasts ~500 real seconds â€” far beyond this test's duration.
force_artist LongAct 100 9999
set_time 10 05
wait_frames 5

# Build narrow (2-tile) paths from map edges, stopping before the
# StageFloor ring (radius 8 from center 32,27 â†’ ring starts ~x=24/x=40, z=19/z=35).
# Left approach (stop at x=23)
draw_path_rect 1 26 23 27
# Right approach (start at x=41)
draw_path_rect 41 26 50 27
# Top approach (stop at z=18)
draw_path_rect 31 1 32 18
# Bottom approach (start at z=36)
draw_path_rect 31 36 32 50
wait_frames 5

screenshot 22_stage_empty

# Spawn agents from all four sides (80 total)
spawn_agents 1 26 20 stage
spawn_agents 50 27 20 stage
spawn_agents 31 1 20 stage
spawn_agents 32 50 20 stage
wait_frames 5

assert_agent_count >= 80

# Wait for agents to cross the map and arrive at stage.
# Reset time to stay safely in Day phase (clock runs at 10x).
wait 15
set_time 11 00

screenshot 22_stage_filling

# Wait more for agents to spread out and settle
wait 15
set_time 12 00

screenshot 22_stage_full

# Most agents should be on StageFloor tiles.
# Threshold is conservative: some agents may still be walking on Path.
assert_agents_on_tiletype stagefloor >= 30

# A good number should be watching the stage
assert_agent_watching >= 10

# Verify agents spread to all four sides of the stage building.
# Check for at least one agent near each side (radius 6 from check point).
# Left side
assert_agent_near 27 27 6
# Right side
assert_agent_near 37 27 6
# Top side
assert_agent_near 32 22 6
# Bottom side
assert_agent_near 32 32 6

screenshot 22_stage_filled
